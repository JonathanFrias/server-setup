set -e # Quit on error
sh pacaur

patch /mnt/etc/xdg/pacaur/config < ../chroot/etc/xdg/pacaur/config.patch
# This next command is going to take a long time to run...
arch-chroot /mnt pacaur -S postfix squirrelmail mariadb apache openssl --asroot --noconfirm

cp ../bin/* /mnt/root/aur_builds/
arch-chroot /mnt pacman -U ~/aur_builds/courier-authlib-0.65.0-11-x86_64.pkg.tar.xz --noconfirm
arch-chroot /mnt pacman -U ~/aur_builds/courier-maildrop-2.6.0-2-x86_64.pkg.tar.xz --noconfirm
arch-chroot /mnt pacman -U ~/aur_builds/courier-imap-4.13-11-x86_64.pkg.tar.xz --noconfirm

user_group=vmail 
arch-chroot /mnt groupadd -g 5003 $user_group
arch-chroot /mnt useradd -g $user_group -u 5003 -d /home/vmailer -s /bin/false vmailer
arch-chroot /mnt mkdir /home/vmailer
arch-chroot /mnt chown -R vmailer:vmail /home/vmailer
arch-chroot /mnt chmod -R 750 /home/vmailer
echo "vmailer:vmailer" >> /mnt/root/passwords
arch-chroot /mnt chpasswd < /mnt/root/passwords

patch /mnt/etc/postfix/main.cf < ../chroot/etc/postfix/main.cf.patch
arch-chroot /mnt postconf -d mailbox_size_limit
arch-chroot /mnt postconf -d message_size_limit

patch /mnt/etc/postfix/aliases < ../chroot/etc/postfix/aliases.patch
arch-chroot /mnt postalias /etc/postfix/aliases

cp ../chroot/etc/postfix/virtual_alias /mnt/etc/postfix/virtual_alias
arch-chroot /mnt postalias /etc/postfix/virtual_alias

cp ../chroot/etc/postfix/mysql_virtual_domains.cf /mnt/etc/postfix/mysql_virtual_domains.cf
